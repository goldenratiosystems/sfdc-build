<?xml version="1.0"?>

<project name="deploy" xmlns:sf="antlib:com.salesforce">

	<target name="deploy" depends="build,clearPackage"/>

    <target name="buildzip">
        <echo>Salesforce Username: ${sf.username}</echo>
      <sf:deploy
            username="${sf.username}"
            password="${sf.password}"
            serverurl="${sf.server}"
            zipFile="deploy.zip"
            maxPoll="200"
            pollWaitMillis="50000"
            rollbackOnError="true"
            singlePackage="true"
            allowMissingFiles="false"
            logType="Detail"
            checkOnly="${checkOnly}"
        />
    </target>

	<target name="build" depends="makePackage">
		<echo>Salesforce Username: ${sf.username}</echo>
	  <sf:deploy
			username="${sf.username}"
			password="${sf.password}"
			serverurl="${sf.server}"
			zipFile="deploy.zip"
			maxPoll="200"
			pollWaitMillis="50000"
			rollbackOnError="true"
			singlePackage="true"
			allowMissingFiles="false"
            logType="Detail"
            checkOnly="${checkOnly}"
		/>
	</target>

	<target name="clearPackage">
		<delete file="deploy.zip" failonerror="false"/>
	</target>

    <target name="makeProfiles">
        <mkdir dir="makeProfiles" />
        <echoxml file="makeProfiles/package.xml" namespacePolicy="all">
            <Package xmlns="http://soap.sforce.com/2006/04/metadata">
                <types>
                    <name>Profile</name>
                    <members>*</members>
                </types>
                <version>40.0</version>
            </Package>
        </echoxml>
        <zip destfile="deployProfiles.zip" update="true">
        <fileset dir="makeProfiles" includes="package.xml"/>
        <fileset dir="temp/destroy/" includes="profiles/*.profile"/>
        </zip>
    </target>

    <target name="buildProfiles">
        <echo>Salesforce Username: ${sf.username}</echo>
      <sf:deploy
            username="${sf.username}"
            password="${sf.password}"
            serverurl="${sf.server}"
            zipFile="deployProfiles.zip"
            maxPoll="200"
            pollWaitMillis="50000"
            rollbackOnError="true"
            singlePackage="true"
            allowMissingFiles="false"
            logType="Detail"
        />
    </target>

    <target name="retrieveFlexipages">
        <mkdir dir="retrieveFlexipages" />
        <mkdir dir="retrieveFlexipages/src" />
        <echoxml file="retrieveFlexipages/src/package.xml" namespacePolicy="all">
            <Package xmlns="http://soap.sforce.com/2006/04/metadata">
                <types>
                    <name>FlexiPage</name>
                    <members>*</members>
                </types>
                <version>40.0</version>
            </Package>
        </echoxml>
        <echo>Salesforce Username: ${sf.username}</echo>
        <sf:retrieve
            username="${sf.username}"
            password="${sf.password}"
            serverurl="${sf.server}"
            retrieveTarget="retrieveFlexipages/src"
            unpackaged="retrieveFlexipages/src/package.xml"
            maxPoll="2000"
            pollWaitMillis="5000"
        />
    </target>

    <target name="retrieveCustomObjects">
        <delete dir="retrieveCustomObjects" failonerror="false"/>
        <mkdir dir="retrieveCustomObjects" />
        <mkdir dir="retrieveCustomObjects/src" />
        <echoxml file="retrieveCustomObjects/src/package.xml" namespacePolicy="all">
            <Package xmlns="http://soap.sforce.com/2006/04/metadata">
                <types>
                    <name>CustomObject</name>
                    <members>Case</members>
                    <members>OpportunityLineItem</members>
                    <members>*</members>
                </types>
                <version>40.0</version>
            </Package>
        </echoxml>
        <echo>Salesforce Username: ${sf.username}</echo>
        <sf:retrieve
            username="${sf.username}"
            password="${sf.password}"
            serverurl="${sf.server}"
            retrieveTarget="retrieveCustomObjects/src"
            unpackaged="retrieveCustomObjects/src/package.xml"
            maxPoll="2000"
            pollWaitMillis="5000"
        />
        <replace dir="retrieveCustomObjects/src">
            <include name="**/*.object"/>
            <replacefilter>
                <replacetoken><![CDATA[<type>MasterDetail</type>]]></replacetoken>
                <replacevalue><![CDATA[<type>Lookup</type>]]></replacevalue>
            </replacefilter>
        </replace>
        <replaceregexp flags="gm"
            match="&lt;webLinks&gt;[\s\S]*?&lt;\/webLinks&gt;"
            replace="&lt;!--\0--&gt;">
            <fileset dir="retrieveCustomObjects/src">
                <include name="**/*.object"/>
            </fileset>
        </replaceregexp>
        <replaceregexp flags="gm"
            match="&lt;lookupFilter&gt;[\s\S]*?&lt;\/lookupFilter&gt;"
            replace="&lt;!--\0--&gt;">
            <fileset dir="retrieveCustomObjects/src">
                <include name="**/*.object"/>
            </fileset>
        </replaceregexp>
        <replaceregexp flags="gm"
            match="&lt;relationshipOrder&gt;[\s\S]*?&lt;\/relationshipOrder&gt;"
            replace="&lt;!--\0--&gt;">
            <fileset dir="retrieveCustomObjects/src">
                <include name="**/*.object"/>
            </fileset>
        </replaceregexp>
        <replaceregexp flags="gm"
            match="&lt;reparentableMasterDetail&gt;[\s\S]*?&lt;\/reparentableMasterDetail&gt;"
            replace="&lt;!--\0--&gt;">
            <fileset dir="retrieveCustomObjects/src">
                <include name="**/*.object"/>
            </fileset>
        </replaceregexp>
        <replaceregexp flags="gm"
            match="&lt;sharingModel&gt;[\s\S]*?&lt;\/sharingModel&gt;"
            replace="&lt;sharingModel&gt;ReadWrite&lt;\/sharingModel&gt;">
            <fileset dir="retrieveCustomObjects/src">
                <include name="**/*.object"/>
            </fileset>

        </replaceregexp>
        <replaceregexp flags="gm"
            match="&lt;externalSharingModel&gt;[\s\S]*?&lt;\/externalSharingModel&gt;"
            replace="&lt;externalSharingModel&gt;ReadWrite&lt;\/externalSharingModel&gt;">
            <fileset dir="retrieveCustomObjects/src">
                <include name="**/*.object"/>
            </fileset>

        </replaceregexp>

        <replaceregexp flags="gm"
            match="&lt;externalSharingModel&gt;[\s\S]*?&lt;\/externalSharingModel&gt;"
            replace="&lt;externalSharingModel&gt;ReadWrite&lt;\/externalSharingModel&gt;">
            <fileset dir="retrieveCustomObjects/src">
                <include name="**/*.object"/>
            </fileset>

        </replaceregexp>

        <!--<replaceregexp flags="gs">
            <regexp pattern="&lt;fields&gt;.*&lt;fullName&gt;([^&lt;]+)&lt;/fullName&gt;.*&lt;externalId&gt;([^&lt;]+)&lt;/externalId&gt;.*&lt;formula&gt;([^&lt;]+)&lt;/formula&gt;.*&lt;formulaTreatBlanksAs&gt;([^&lt;]+)&lt;/formulaTreatBlanksAs&gt;.*&lt;label&gt;([^&lt;]+)&lt;/label&gt;.*&lt;trackTrending&gt;([^&lt;]+)&lt;/trackTrending&gt;.*&lt;type&gt;Checkbox&lt;/type&gt;.*&lt;/fields&gt;" />
            <substitution expression="&lt;fields&gt;${line.separator}&lt;fullName&gt;\1&lt;/fullName&gt;${line.separator}&lt;externalId&gt;\2&lt;/externalId&gt;${line.separator}&lt;formula&gt;false&lt;/formula&gt;${line.separator}&lt;formulaTreatBlanksAs&gt;\4&lt;/formulaTreatBlanksAs&gt;${line.separator}&lt;label&gt;\5&lt;/label&gt;${line.separator}&lt;trackTrending&gt;\6&lt;/trackTrending&gt;${line.separator}&lt;type&gt;Checkbox&lt;/type&gt;${line.separator}&lt;/fields&gt;" />
            <fileset dir="retrieveCustomObjects/src">
                <include name="**/*.object"/>
            </fileset>

        </replaceregexp>-->

        <replaceFormulaField
            dir="retrieveCustomObjects/src/objects/"
            files="*.object"
            type="Checkbox"
            value="false"
            />

        <replaceFormulaField
            dir="retrieveCustomObjects/src/objects/"
            files="*.object"
            type="Number"
            value="0"
            />

        <replaceFormulaField
            dir="retrieveCustomObjects/src/objects/"
            files="*.object"
            type="Text"
            value="''"
            />



        <!--<antcall target="deployCustomObjects"/>-->
    </target>

    <macrodef name="replaceFormulaField">
        <attribute name="dir" />
        <attribute name="files" />
        <attribute name="type" />
        <attribute name="value" />
        <sequential>
            <echo>Cleanup formula fields - @{type}</echo>
            <xmltask toDir="@{dir}">
                <fileset dir="@{dir}" includes="@{files}" />

                <!--//CustomObject/fields[type='Checkbox' and formula]/formula-->
                <replace path="//:CustomObject/:fields[:type='@{type}' and :formula]/:formula/text()" withText="@{value}"/>
                <remove path="//:CustomObject/:fields[:type='@{type}' and :formula]/:formulaTreatBlanksAs"/>

                <!--<call path="//*[local-name()='CustomObject']/*[local-name()='fields']">-->
                <!--<call path="//:CustomObject/:fields" id="foobar">
                    <param name="fieldFullName" path="*[local-name()='fullName']/text()" default=""/>
                    <param name="fieldFormulaText" path="*[local-name()='formula']/text()" default=""/>
                    <param name="fieldType" path="*[local-name()='type']/text()" default="" id="foobar2"/>
                    <actions>
                        <if>
                            <and>
                                <equals arg1="@{fieldType}" arg2="@{type}" casesensitive="false"/>
                                <not>
                                    <equals arg1="@{fieldFormulaText}" arg2=""/>
                                </not>
                            </and>
                            <then>
                                <echo>field.FullName=@{fieldFullName} - @{fieldType}</echo>
                                <echo>field.Formula.Text=@{fieldFormulaText} ${xmltask.path}</echo>
                                <echo>${toString:foobar2}</echo>

                            </then>
                        </if>

                    </actions>
                </call>-->
            </xmltask>
        </sequential>
    </macrodef>

    <target name="ab">
        <echo>fieldType-----${fieldType} </echo>
    </target>

    <target name="readXML">
        <replaceFormulaField
            dir="retrieveCustomObjects/src/objects/"
            files="*.object"
            type="Number"
            value="0"
            />
    </target>

    <target name="deployCustomObjects">
        <zip destfile="deployCustomObjects.zip" update="true">
            <fileset dir="retrieveCustomObjects/src" includes="package.xml"/>
            <!--<fileset dir="retrieveCustomObjects/src" includes="objects/*.object" excludes="objects/DHP_Promotion__c.object,objects/DHP_Resource_Program__c.object,objects/Product_Schedule__c.object,objects/Quality_Assurance_Response__c.object,objects/Rx_Provider__c.object,objects/SurveyQuestionResponse__c.object,objects/SurveyQuestionResponse__c.object"/>-->
            <!--<fileset dir="retrieveCustomObjects/src" includes="objects/*.object"/>-->
            <fileset dir="retrieveCustomObjects/src" includes="objects/Case.object,objects/OpportunityLineItem.object"/>
        </zip>
        <sf:deploy
            username="${sf.username}"
            password="${sf.password}"
            serverurl="${sf.server}"
            zipFile="deployCustomObjects.zip"
            maxPoll="200"
            pollWaitMillis="50000"
            rollbackOnError="true"
            singlePackage="true"
            allowMissingFiles="false"
            logType="Detail"
        />
    </target>

    <target name="deployFlexipages">
        <zip destfile="deployFlexipages.zip" update="true">
            <fileset dir="retrieveFlexipages/src" includes="package.xml"/>
            <fileset dir="retrieveFlexipages/src" includes="flexipages/*.flexipage"/>
        </zip>
        <sf:deploy
            username="${sf.username}"
            password="${sf.password}"
            serverurl="${sf.server}"
            zipFile="deployFlexipages.zip"
            maxPoll="200"
            pollWaitMillis="50000"
            rollbackOnError="true"
            singlePackage="true"
            allowMissingFiles="false"
            logType="Detail"
        />
    </target>

	<target name="makePackage" description="Deploys code local src dir to salesforce org specified in build.properties!" depends="clearPackage">
	  <zip destfile="deploy.zip" update="true">
		<fileset dir="${github.project.name}/src" includes="package.xml"/>
		<fileset dir="${github.project.name}/src" includes="assignmentRules/*.assignmentRules"/>
		<fileset dir="${github.project.name}/src" includes="classes/*.cls,classes/*-meta.xml"/>
		<fileset dir="${github.project.name}/src" includes="components/*.component,components/*-meta.xml"/>
		<fileset dir="${github.project.name}/src" includes="labels/CustomLabels.labels"/>
        <fileset dir="${github.project.name}/src" includes="documents/**/*.*"/>
        <fileset dir="${github.project.name}/src" includes="email/**/*.*"/>
		<!--<fileset dir="${github.project.name}/src" includes="layouts/*.layout"/>-->
        <fileset dir="${github.project.name}/src" includes="settings/*.settings" excludes="settings/PersonalJourney.settings,
settings/OrgPreference.settings,settings/Case.settings,settings/Search.settings,settings/Opportunity.settings,settings/Ideas.settings"/>
        <!--<fileset dir="${github.project.name}/src" includes="analyticSnapshots/*.snapshot"/>-->
        <fileset dir="${github.project.name}/src" includes="aura/**/*.*"/>
        <fileset dir="${github.project.name}/src" includes="autoResponseRules/*.autoResponseRules"/>
        <!--<fileset dir="${github.project.name}/src" includes="cleanDataServices/*.cleanDataService"/>-->
        <fileset dir="${github.project.name}/src" includes="customMetadata/*.md"/>
        <fileset dir="${github.project.name}/src" includes="customPermissions/*.customPermission"/>
        <fileset dir="${github.project.name}/src" includes="delegateGroups/*.delegateGroup"/>
        <fileset dir="${github.project.name}/src" includes="duplicateRules/*.duplicateRule"/>
        <fileset dir="${github.project.name}/src" includes="escalationRules/*.escalationRule"/>
        <!--<fileset dir="${github.project.name}/src" includes="flowDefinitions/*.flowDefinition"/>
        <fileset dir="${github.project.name}/src" includes="flows/*.flow"/>-->
        <fileset dir="${github.project.name}/src" includes="globalValueSets/*.globalValueSet"/>
        <fileset dir="${github.project.name}/src" includes="groups/*.group"/>
        <fileset dir="${github.project.name}/src" includes="homePageComponents/*.homePageComponent"/>
        <fileset dir="${github.project.name}/src" includes="homePageLayouts/*.homePageLayout"/>
        <fileset dir="${github.project.name}/src" includes="managedTopics/*.managedTopics"/>
        <fileset dir="${github.project.name}/src" includes="matchingRules/*.matchingRule"/>
        <fileset dir="${github.project.name}/src" includes="objectTranslations/*.objectTranslation"/>
        <fileset dir="${github.project.name}/src" includes="permissionsets/*.permissionset" excludes="permissionsets/Create_Processes_INCLUDES_SEE_ALL_DATA.permissionset,permissionsets/Process_Builder.permissionset"/>
        <!--<fileset dir="${github.project.name}/src" includes="profiles/*.profile" excludes="profiles/Admin.profile,profiles/Premier Support User.profile"/>-->
        <fileset dir="${github.project.name}/src" includes="queues/*.queue"/>
        <fileset dir="${github.project.name}/src" includes="quickActions/*.quickAction" excludes="quickActions/SendEmail.quickAction"/>
        <fileset dir="${github.project.name}/src" includes="remoteSiteSettings/*.remoteSite"/>
        <fileset dir="${github.project.name}/src" includes="reportTypes/*.reportType"/>
        <fileset dir="${github.project.name}/src" includes="roles/*.role"/>
        <fileset dir="${github.project.name}/src" includes="sharingRules/*.sharingRules"/>
        <!--<fileset dir="${github.project.name}/src" includes="siteDotComSites/*.site"/>-->
        <fileset dir="${github.project.name}/src" includes="site/*.site"/>
        <fileset dir="${github.project.name}/src" includes="weblinks/*.weblink"/>
        <!--<fileset dir="${github.project.name}/src" includes="workflows/*.workflow"/>-->
        <!--<fileset dir="${github.project.name}/src" includes="applications/*.app" excludes="applications/CSR_Console.app"/>-->
		<fileset dir="${github.project.name}/src" includes="objects/*.object"/>
		<fileset dir="${github.project.name}/src" includes="pages/*.page,pages/*-meta.xml"/>
		<fileset dir="${github.project.name}/src" includes="staticresources/*.resource,staticresources/*-meta.xml"/>
		<!--<fileset dir="${github.project.name}/src" includes="tabs/*.tab"/>-->
		<fileset dir="${github.project.name}/src" includes="triggers/*.trigger,triggers/*-meta.xml"/>
	  </zip>
	</target>

    <target name="retrieve-clear">
        <delete dir="${retrieve.dir}" failonerror="false"/>
    </target>

    <target name="retrieve-create">
        <mkdir dir="${retrieve.dir}"/>
        <mkdir dir="${retrieve.dir}/src"/>
    </target>

    <target name="retrieve-metadata" depends="retrieve-clear, retrieve-create, copy-package">
        <sf:retrieve
            username="${sf.username}"
            password="${sf.password}"
            serverurl="${sf.server}"
            retrieveTarget="${retrieve.dir}/src"
            unpackaged="${retrieve.dir}/src/package.xml"
            maxPoll="2000"
            pollWaitMillis="5000"/>

        <antcall target="copy-meta"/>
    </target>

     <target name="copy-package">
        <copy file="${github.project.name}/src/package.xml" todir="${retrieve.dir}/src">
        </copy>
    </target>
    <target name="copy-meta">
        <copy todir="${github.project.name}/src">
            <fileset dir="${retrieve.dir}/src" includes="assignmentRules/*.assignmentRules"/>
            <fileset dir="${retrieve.dir}/src" includes="classes/*.cls,classes/*-meta.xml"/>
            <fileset dir="${retrieve.dir}/src" includes="components/*.component,components/*-meta.xml"/>
            <fileset dir="${retrieve.dir}/src" includes="labels/CustomLabels.labels"/>
            <fileset dir="${retrieve.dir}/src" includes="settings/*.settings" excludes="settings/PersonalJourney.settings,
    settings/OrgPreference.settings,settings/Case.settings,settings/Search.settings,settings/Opportunity.settings,settings/Ideas.settings"/>
            <fileset dir="${retrieve.dir}/src" includes="analyticSnapshots/*.snapshot"/>
            <fileset dir="${retrieve.dir}/src" includes="aura/**/*.*"/>
            <fileset dir="${retrieve.dir}/src" includes="autoResponseRules/*.autoResponseRules"/>
            <fileset dir="${retrieve.dir}/src" includes="customMetadata/*.md"/>
            <fileset dir="${retrieve.dir}/src" includes="customPermissions/*.customPermission"/>
            <fileset dir="${retrieve.dir}/src" includes="delegateGroups/*.delegateGroup"/>
            <fileset dir="${retrieve.dir}/src" includes="duplicateRules/*.duplicateRule"/>
            <fileset dir="${retrieve.dir}/src" includes="escalationRules/*.escalationRule"/>
            <fileset dir="${retrieve.dir}/src" includes="globalValueSets/*.globalValueSet"/>
            <fileset dir="${retrieve.dir}/src" includes="groups/*.group"/>
            <fileset dir="${retrieve.dir}/src" includes="homePageComponents/*.homePageComponent"/>
            <fileset dir="${retrieve.dir}/src" includes="homePageLayouts/*.homePageLayout"/>
            <fileset dir="${retrieve.dir}/src" includes="managedTopics/*.managedTopics"/>
            <fileset dir="${retrieve.dir}/src" includes="matchingRules/*.matchingRule"/>
            <fileset dir="${retrieve.dir}/src" includes="objectTranslations/*.objectTranslation"/>
            <fileset dir="${retrieve.dir}/src" includes="permissionsets/*.permissionset" excludes="permissionsets/Create_Processes_INCLUDES_SEE_ALL_DATA.permissionset,permissionsets/Process_Builder.permissionset"/>
            <!--<fileset dir="${retrieve.dir}/src" includes="queues/*.queue"/>-->
            <fileset dir="${retrieve.dir}/src" includes="quickActions/*.quickAction" excludes="quickActions/SendEmail.quickAction"/>
            <fileset dir="${retrieve.dir}/src" includes="remoteSiteSettings/*.remoteSite"/>
            <fileset dir="${retrieve.dir}/src" includes="reportTypes/*.reportType"/>
            <fileset dir="${retrieve.dir}/src" includes="roles/*.role"/>
            <fileset dir="${retrieve.dir}/src" includes="sharingRules/*.sharingRules"/>
            <fileset dir="${retrieve.dir}/src" includes="site/*.site"/>
            <fileset dir="${retrieve.dir}/src" includes="weblinks/*.weblink"/>
            <fileset dir="${retrieve.dir}/src" includes="objects/*.object"/>
            <fileset dir="${retrieve.dir}/src" includes="pages/*.page,pages/*-meta.xml"/>
            <fileset dir="${retrieve.dir}/src" includes="staticresources/*.resource,staticresources/*-meta.xml"/>
            <fileset dir="${retrieve.dir}/src" includes="triggers/*.trigger,triggers/*-meta.xml"/>
        </copy>
    </target>

</project>
